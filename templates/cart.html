{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
    <h2 class="fw-bold mb-4">ðŸ›’ Your Cart</h2>
    {% if cart_items %}
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="bg-white rounded-4 p-4 shadow-sm">
                {% for item in cart_items %}
                <div class="d-flex align-items-center mb-3 border-bottom pb-3 item-row" data-id="{{ item.food.id }}">
                    <img src="{{ item.food.image.url }}" class="rounded-3 me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-0">{{ item.food.name }}</h6>
                        <span class="text-success fw-bold">${{ item.food.price }}</span>
                    </div>
                    
                    <div class="d-flex align-items-center bg-light rounded-pill px-2">
                        <button class="btn btn-sm btn-update" data-action="minus">
                            <i class="fas fa-minus text-danger"></i>
                        </button>
                        <span class="mx-3 fw-bold qty-val">{{ item.quantity }}</span>
                        <button class="btn btn-sm btn-update" data-action="plus">
                            <i class="fas fa-plus text-success"></i>
                        </button>
                    </div>
                    
                    <div class="ms-4 text-end" style="min-width: 80px;">
                        <span class="fw-bold subtotal-val">${{ item.subtotal }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-lg-4">
            <div class="bg-white rounded-4 p-4 shadow-sm">
                <h5 class="fw-bold mb-3">Summary</h5>
                <div class="d-flex justify-content-between mb-4">
                    <span class="fs-5">Total Bill:</span>
                    <span class="fs-5 fw-bold text-success" id="grand-total">${{ total }}</span>
                </div>
                <a href="{% url 'checkout' %}" class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow">Order Now</a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <h3>Cart is empty! ðŸ˜”</h3>
        <a href="{% url 'home' %}" class="btn btn-success mt-3 px-5 py-2 rounded-pill">Add Something Delicious</a>
    </div>
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).on('click', '.btn-update', function(e){
    e.preventDefault();
    var $btn = $(this);
    var $row = $btn.closest('.item-row'); // Har item ki row
    var foodId = $row.data('id');
    var action = $btn.data('action');

    // AJAX Call
    $.ajax({
        url: "/update-cart/" + foodId + "/" + action + "/",
        type: 'GET',
        success: function(response){
            if(response.quantity <= 0){
                $row.fadeOut(300, function() { $(this).remove(); });
            } else {
                $row.find('.qty-val').text(response.quantity);
                $row.find('.subtotal-val').text('$' + response.subtotal);
            }
            
            // Total bill aur Navbar count update
            $('#grand-total').text('$' + response.total);
            $('#cart-count').text(response.cart_count);

            if(response.cart_count == 0){
                location.reload(); // Agar sab khali ho jaye toh refresh
            }
        },
        error: function(){
            alert("Error: Update nahi ho paya!");
        }
    });
});
</script>
{% endblock %}